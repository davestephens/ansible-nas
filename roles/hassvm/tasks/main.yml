---
- name: Check if VM image exists
  stat:
    path: "{{hassvm_image}}"
  register: hassvm_image_exists

- name: Download VM image
  get_url:
    url: https://github.com/home-assistant/operating-system/releases/download/7.2/haos_ova-7.2.qcow2.xz
    dest: "{{hassvm_image}}.xz"
  register: download
  when: not hassvm_image_exists.stat.exists

- name: Uncompress VM image
  command: xz -d "{{ download.dest }}"
  when: download.changed

#- name: Define HassVM
#  community.libvirt.virt:
#    command: define
#    name: homeassistant
- name: Create XML definition for domain
  template:
    src: hassvm.xml.j2
    dest: "/hassvm.xml"
- name: Check whether the domain already exists 
  shell: |
    virsh list --all | grep "homeassistant" | wc -l 
  register:
    virsh_list_output
- name: Define domain if needed 
  shell: |
    virsh define /hassvm.xml
  when: virsh_list_output.stdout == "0"
#    xml: "{{ lookup('template', 'hassvm.xml.j2') }}"



- name: Start HassVM
  community.libvirt.virt:
    state: running
    name: homeassistant
