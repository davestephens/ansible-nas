---
- name: Create Traefik Directories
  file:
    mode: "{{ item.mode | default('0750') }}"
    path: "{{ item.path }}"
    state: "directory"
  tags:
    - traefik
    - traefik:dir
  with_items:
    - path: "{{ traefik_data_directory }}"
      mode: "0755"
    - path: "{{ traefik_data_directory }}/letsencrypt"
      mode: "0700"

- name: Template Traefik Files
  register: template_config
  tags:
    - traefik
    - traefik:template
  template:
    dest: "{{ item.dest }}"
    force: "{{ item.force | default('No') }}"
    mode: "{{ item.mode | default('0600') }}"
    src: "{{ item.src }}"
  with_items: "{{ traefik_template_files + traefik_template_files_custom | sort }}"

- name: Traefik Docker Container
  docker_container:
    env: "{{ traefik_environment_variables }}"
    image: "{{ traefik_image }}"
    memory: "{{ traefik_memory }}"
    name: traefik
    network_mode: host
    pull: true
    recreate: "{{ template_config is changed }}"
    restart_policy: unless-stopped
    volumes: "{{ traefik_volumes + traefik_volumes_custom | sort }}"
  tags:
    - traefik
    - traefik:docker
