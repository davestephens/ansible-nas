---
- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items: "{{ nextcloud_data_subdirectories + nextcloud_data_subdirectories_custom | sort }}"
  tags:
    - nextcloud:dir

- name: Utils
  include_tasks: utils.yml
  tags:
    - nextcloud:utils
  when: nextcloud_utils_enabled

- name: Mysql Container
  docker_container:
    name: nextcloud-mysql
    image: "{{ nextcloud_sql_image }}"
    pull: true
    volumes: "{{ nextcloud_sql_volumes + nextcloud_sql_volumes_custom | sort }}"
    env:
      MYSQL_DATABASE: "nextcloud"
      MYSQL_USER: "{{ nextcloud_sql_user }}"
      MYSQL_PASSWORD: "{{ nextcloud_sql_password }}"
      MYSQL_ROOT_PASSWORD: "{{ nextcloud_sql_root_password }}"
    restart_policy: unless-stopped
    memory: "{{ nextcloud_sql_memory }}"
    capabilities:
      - sys_nice
    container_default_behavior: compatibility
  tags:
    - nextcloud:sql

- name: Nextcloud Container
  docker_container:
    name: nextcloud
    image: "{{ nextcloud_image_fpm if nextcloud_nginx_enabled else nextcloud_image }}"
    pull: true
    links:
      - nextcloud-mysql:mysql
    volumes: "{{ nextcloud_volumes + nextcloud_volumes_custom }}"
    env:
      MYSQL_HOST: "mysql"
      MYSQL_DATABASE: "nextcloud"
      MYSQL_USER: "{{ nextcloud_sql_user }}"
      MYSQL_PASSWORD: "{{ nextcloud_sql_password }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "{{ nextcloud_trusted_domains | default([nextcloud_hostname,ansible_nas_domain] | concat('.')) }}"
    restart_policy: unless-stopped
    memory: "{{ nextcloud_sql_memory }}"
    labels: "{{ {} if nextcloud_nginx_enabled else nextcloud_labels }}"
    container_default_behavior: compatibility
  tags:
    - nextcloud:php

- name: Nginx
  include_tasks: nginx.yml
  tags:
    - nextcloud:nginx
  when: nextcloud_nginx_enabled
