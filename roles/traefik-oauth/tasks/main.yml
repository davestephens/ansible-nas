---
- name: Traefik-forward-auth Docker Container
  docker_container:
    name: traefik-forward-auth
    image: "thomseddon/traefik-forward-auth:latest"
    pull: true
    env:
      PROVIDERS_GOOGLE_CLIENT_ID: "{{ google_oauth_client_id }}"
      PROVIDERS_GOOGLE_CLIENT_SECRET: "{{ google_oauth_client_secret }}"
      SECRET: "{{ oauth_secret }}"
      LOG_LEVEL: "debug"
      COOKIE_DOMAIN: "{{ ansible_nas_domain }}"
      WHITELIST: "{{oauth_whitelist}}"
    restart_policy: unless-stopped
    memory: 1G
    ports:
        4181:4181
    labels:
      traefik.enable: "true"
      traefik.http.routers.oauth.rule: "Host(`oauth.{{ ansible_nas_domain }}`)"
      traefik.http.routers.oauth.tls.certresolver: "letsencrypt"
      traefik.http.routers.oauth.tls.domains[0].main: "{{ ansible_nas_domain }}"
      traefik.http.routers.oauth.tls.domains[0].sans: "*.{{ ansible_nas_domain }}"
      traefik.http.routers.oauth.service: "traefik-forward-auth"

      traefik.http.middlewares.traefik-forward-auth.forwardauth.address: "http://192.168.1.3:4181"
      traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders: "X-Forwarded-User"
      traefik.http.middlewares.traefik-forward-auth.forwardauth.trustForwardHeader: "true"
      traefik.http.routers.oauth.middlewares: "traefik-forward-auth"

